# Apache2 Configuration untuk Aplikasi Pajak Next.js
# Simpan file ini di /etc/apache2/sites-available/pajak-nextjs.conf

<VirtualHost *:80>
    ServerName iqbaldev.site
    ServerAdmin webmaster@iqbaldev.site
    DocumentRoot /var/www/html

    # Enable required modules
    LoadModule proxy_module modules/mod_proxy.so
    LoadModule proxy_http_module modules/mod_proxy_http.so
    LoadModule headers_module modules/mod_headers.so
    LoadModule rewrite_module modules/mod_rewrite.so
    LoadModule ssl_module modules/mod_ssl.so

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'"

    # Enable compression
    LoadModule deflate_module modules/mod_deflate.so
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
    </IfModule>

    # Rate limiting (requires mod_ratelimit)
    # LoadModule ratelimit_module modules/mod_ratelimit.so
    # <Location "/pajakapp/api/">
    #     SetOutputFilter RATE_LIMIT
    #     SetEnv rate-limit 10
    # </Location>

    # API routes with rate limiting
    <Location "/pajakapp/api/">
        ProxyPass http://localhost:3000/api/
        ProxyPassReverse http://localhost:3000/api/
        
        # Security headers for API
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "DENY"
    </Location>

    # Login route with stricter rate limiting
    <Location "/pajakapp/api/auth/">
        ProxyPass http://localhost:3000/api/auth/
        ProxyPassReverse http://localhost:3000/api/auth/
        
        # Additional security for auth endpoints
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "DENY"
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
    </Location>

    # Static files with caching
    <Location "/pajakapp/_next/static/">
        ProxyPass http://localhost:3000/_next/static/
        ProxyPassReverse http://localhost:3000/_next/static/
        
        # Cache static files for 1 year
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header always set Cache-Control "public, immutable"
    </Location>

    # Public files with caching
    <Location "/pajakapp/public/">
        ProxyPass http://localhost:3000/public/
        ProxyPassReverse http://localhost:3000/public/
        
        # Cache public files for 1 day
        ExpiresActive On
        ExpiresDefault "access plus 1 day"
        Header always set Cache-Control "public"
    </Location>

    # Health check endpoint
    <Location "/pajakapp/health">
        ProxyPass http://localhost:3000/health
        ProxyPassReverse http://localhost:3000/health
        
        # No caching for health checks
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </Location>

    # All other routes under /pajakapp
    <Location "/pajakapp/">
        ProxyPass http://localhost:3000/
        ProxyPassReverse http://localhost:3000/
        
        # Enable WebSocket support
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/pajakapp/?(.*) "ws://localhost:3000/$1" [P,L]
    </Location>

    # Redirect root to /pajakapp
    <Location "/">
        Redirect permanent / /pajakapp/
    </Location>

    # Error logs
    ErrorLog ${APACHE_LOG_DIR}/pajak_error.log
    CustomLog ${APACHE_LOG_DIR}/pajak_access.log combined

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Timeout settings
    ProxyTimeout 300
    ProxyBadHeader Ignore
</VirtualHost>

# HTTPS Configuration (uncomment and configure SSL certificates)
# <VirtualHost *:443>
#     ServerName iqbaldev.site
#     ServerAdmin webmaster@iqbaldev.site
#     DocumentRoot /var/www/html
#
#     # SSL Configuration
#     SSLEngine on
#     SSLCertificateFile /etc/ssl/certs/iqbaldev.site.crt
#     SSLCertificateKeyFile /etc/ssl/private/iqbaldev.site.key
#     SSLCertificateChainFile /etc/ssl/certs/iqbaldev.site-chain.crt
#
#     # SSL Security Settings
#     SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
#     SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384
#     SSLHonorCipherOrder on
#     SSLCompression off
#
#     # HSTS (HTTP Strict Transport Security)
#     Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
#
#     # Same location blocks as above for HTTPS
#     <Location "/pajakapp/">
#         ProxyPass http://localhost:3000/
#         ProxyPassReverse http://localhost:3000/
#     </Location>
#
#     # Redirect root to /pajakapp
#     <Location "/">
#         Redirect permanent / /pajakapp/
#     </Location>
#
#     # Error logs
#     ErrorLog ${APACHE_LOG_DIR}/pajak_ssl_error.log
#     CustomLog ${APACHE_LOG_DIR}/pajak_ssl_access.log combined
# </VirtualHost> 